@using System;
@using System.Linq;
@using Sandbox;
@using Sandbox.UI;
@inherits PanelComponent

@namespace Rhythm4K

<root>
	@if(Index < 0 || Index >= BeatmapSet.All.Count()) return;
	<img src="@Set.CoverArt" class="cover" />
	<div class="info">
		<div class="title">@(Set.Name)</div>
		<div class="subtitle">
			<label class="artist">@(Set.Artist)</label>
			<label class="charter">@(Set.BPM)BPM</label>
		</div>
	</div>
</root>

@code
{
	public int Index { get; set; } = -1;
	public BeatmapSet Set => BeatmapSet.All[Index];

	bool Grabbing = false;
	Vector2 GrabPos = Vector2.Zero;

	protected override void OnUpdate()
	{
		base.OnUpdate();

		if(Grabbing)
		{
			var drag = Mouse.Position - GrabPos;

			var carousel = SongListCarousel.Instance;
			carousel.AngleOffset = -drag.y / 360f;
			if ( MathF.Abs( carousel.LastOffset - carousel.AngleOffset ) >= MathF.PI * 2f / (float)carousel.SongPanelCount )
			{
				Sound.Play( "ui_hover" );
				carousel.LastOffset = carousel.AngleOffset;
				carousel.LockOffset();
				GrabPos = Mouse.Position;
			}

			if(!Input.Down("click"))
			{
				if(drag.Length < 16)
				{
					// Clicked
					Click();
				}
				carousel.LockOffset();
				Grabbing = false;
			}
		}
	}

	public void Click()
	{

	}

	public void Grab()
	{
		GrabPos = Mouse.Position;
		Grabbing = true;
	}

	protected override int BuildHash() => System.HashCode.Combine( Index, SongListCarousel.Instance.SelectedIndex );
}